<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Profile Card</title>
		<link rel="stylesheet" href="ProfileCard.css" />
		<style nonce>
			/* Tambahkan gaya dasar supaya terlihat */
			body {
				background: #111;
				display: flex;
				justify-content: center;
				align-items: center;
				height: 100vh;
			}
		</style>
	</head>
	<body>
		<!-- Wrapper utama -->
		<div id="profile-card" class="pc-card-wrapper"></div>

		<script nonce>
			// =============================
			// KONFIGURASI DASAR
			// =============================
			const DEFAULT_INNER_GRADIENT =
				'linear-gradient(145deg,#60496e8c 0%,#71C4FF44 100%)';
			const ANIMATION_CONFIG = {
				INITIAL_DURATION: 1200,
				INITIAL_X_OFFSET: 70,
				INITIAL_Y_OFFSET: 60,
				DEVICE_BETA_OFFSET: 20,
				ENTER_TRANSITION_MS: 180,
			};

			const clamp = (v, min = 0, max = 100) =>
				Math.min(Math.max(v, min), max);
			const round = (v, precision = 3) =>
				parseFloat(v.toFixed(precision));
			const adjust = (v, fMin, fMax, tMin, tMax) =>
				round(tMin + ((tMax - tMin) * (v - fMin)) / (fMax - fMin));

			// =============================
			// INISIALISASI CARD
			// =============================
			function createProfileCard(options = {}) {
				const {
					avatarUrl = 'https://cdn.ab-rust.xyz/file/1762874532905.jpg',
					iconUrl = 'https://cdn.ab-rust.xyz/file/1762874532905.jpg',
					grainUrl = 'https://cdn.ab-rust.xyz/file/1762874532905.jpg',
					innerGradient,
					behindGlowEnabled = true,
					behindGlowColor = 'rgba(125, 190, 255, 0.67)',
					behindGlowSize = '50%',
					enableTilt = true,
					enableMobileTilt = false,
					mobileTiltSensitivity = 5,
					miniAvatarUrl,
					name = 'Javi A. Torres',
					title = 'Software Engineer',
					handle = 'javicodes',
					status = 'Online',
					contactText = 'Contact',
					showUserInfo = true,
					onContactClick = () => alert(`Contact ${name}`),
				} = options;

				// Buat elemen utama
				const wrap = document.createElement('div');
				wrap.className = 'pc-card-wrapper';
				wrap.style.setProperty(
					'--icon',
					iconUrl ? `url(${iconUrl})` : 'none'
				);
				wrap.style.setProperty(
					'--grain',
					grainUrl ? `url(${grainUrl})` : 'none'
				);
				wrap.style.setProperty(
					'--inner-gradient',
					innerGradient ?? DEFAULT_INNER_GRADIENT
				);
				wrap.style.setProperty('--behind-glow-color', behindGlowColor);
				wrap.style.setProperty('--behind-glow-size', behindGlowSize);

				if (behindGlowEnabled) {
					const behind = document.createElement('div');
					behind.className = 'pc-behind';
					wrap.appendChild(behind);
				}

				const shell = document.createElement('div');
				shell.className = 'pc-card-shell';
				wrap.appendChild(shell);

				const section = document.createElement('section');
				section.className = 'pc-card';
				shell.appendChild(section);

				const inside = document.createElement('div');
				inside.className = 'pc-inside';
				section.appendChild(inside);

				inside.innerHTML = `
        <div class="pc-shine"></div>
        <div class="pc-glare"></div>
        <div class="pc-content pc-avatar-content">
          <img class="avatar" src="${avatarUrl}" alt="${name} avatar" loading="lazy" />
          ${
				showUserInfo
					? `
            <div class="pc-user-info">
              <div class="pc-user-details">
                <div class="pc-mini-avatar">
                  <img src="${
						miniAvatarUrl || avatarUrl
					}" alt="${name} mini avatar" loading="lazy" />
                </div>
                <div class="pc-user-text">
                  <div class="pc-handle">@${handle}</div>
                  <div class="pc-status">${status}</div>
                </div>
              </div>
              <button class="pc-contact-btn" type="button">${contactText}</button>
            </div>
          `
					: ''
			}
        </div>
        <div class="pc-content">
          <div class="pc-details">
            <h3>${name}</h3>
            <p>${title}</p>
          </div>
        </div>
      `;

				// Tambahkan event klik tombol contact
				const contactBtn = inside.querySelector('.pc-contact-btn');
				if (contactBtn)
					contactBtn.addEventListener('click', onContactClick);

				// =============================
				// SISTEM TILT
				// =============================
				if (enableTilt) {
					const tiltEngine = (() => {
						let rafId = null,
							running = false,
							lastTs = 0;
						let currentX = 0,
							currentY = 0,
							targetX = 0,
							targetY = 0;
						const DEFAULT_TAU = 0.14,
							INITIAL_TAU = 0.6;
						let initialUntil = 0;

						const setVarsFromXY = (x, y) => {
							const width = shell.clientWidth || 1;
							const height = shell.clientHeight || 1;

							const percentX = clamp((100 / width) * x);
							const percentY = clamp((100 / height) * y);

							const centerX = percentX - 50;
							const centerY = percentY - 50;

							const props = {
								'--pointer-x': `${percentX}%`,
								'--pointer-y': `${percentY}%`,
								'--background-x': `${adjust(
									percentX,
									0,
									100,
									35,
									65
								)}%`,
								'--background-y': `${adjust(
									percentY,
									0,
									100,
									35,
									65
								)}%`,
								'--rotate-x': `${round(-(centerX / 5))}deg`,
								'--rotate-y': `${round(centerY / 4)}deg`,
							};
							for (const [k, v] of Object.entries(props))
								wrap.style.setProperty(k, v);
						};

						const step = (ts) => {
							if (!running) return;
							if (lastTs === 0) lastTs = ts;
							const dt = (ts - lastTs) / 1000;
							lastTs = ts;

							const tau =
								ts < initialUntil ? INITIAL_TAU : DEFAULT_TAU;
							const k = 1 - Math.exp(-dt / tau);

							currentX += (targetX - currentX) * k;
							currentY += (targetY - currentY) * k;
							setVarsFromXY(currentX, currentY);

							const stillFar =
								Math.abs(targetX - currentX) > 0.05 ||
								Math.abs(targetY - currentY) > 0.05;
							if (stillFar) rafId = requestAnimationFrame(step);
							else running = false;
						};

						const start = () => {
							if (!running) {
								running = true;
								rafId = requestAnimationFrame(step);
							}
						};

						return {
							setTarget(x, y) {
								targetX = x;
								targetY = y;
								start();
							},
							toCenter() {
								this.setTarget(
									shell.clientWidth / 2,
									shell.clientHeight / 2
								);
							},
							beginInitial(d) {
								initialUntil = performance.now() + d;
								start();
							},
						};
					})();

					const getOffsets = (evt) => {
						const rect = shell.getBoundingClientRect();
						return {
							x: evt.clientX - rect.left,
							y: evt.clientY - rect.top,
						};
					};

					shell.addEventListener('pointermove', (e) => {
						const { x, y } = getOffsets(e);
						tiltEngine.setTarget(x, y);
					});

					shell.addEventListener('pointerenter', (e) => {
						shell.classList.add('active');
						const { x, y } = getOffsets(e);
						tiltEngine.setTarget(x, y);
					});

					shell.addEventListener('pointerleave', () => {
						tiltEngine.toCenter();
						shell.classList.remove('active');
					});

					// Inisialisasi awal
					const initialX =
						shell.clientWidth - ANIMATION_CONFIG.INITIAL_X_OFFSET;
					const initialY = ANIMATION_CONFIG.INITIAL_Y_OFFSET;
					tiltEngine.setTarget(initialX, initialY);
					tiltEngine.toCenter();
					tiltEngine.beginInitial(ANIMATION_CONFIG.INITIAL_DURATION);
				}

				return wrap;
			}

			// Render ke dalam halaman
			const container = document.getElementById('profile-card');
			const card = createProfileCard();
			container.replaceWith(card);
		</script>
	</body>
</html>
